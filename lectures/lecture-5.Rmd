---
title: 'Оптимизация инвестиционных портфелей <br> "Количественные финансы" '
author: "Салихов Марсель (marcel.salikhov@gmail.com)"
date: "2021-02-03"
output:
  slidy_presentation:
    css: styles.css
    footer: НИУ ВШЭ. Салихов Марсель (marcel.salikhov@gmail.com)
    lib_dir: libs
    self_contained: no
---

## Цели лекции 

+ изучить основы современной портфельной теории (портфельная теория Марковица)
+ понять, что такое безрисковая ставка    
+ понять, как рассчитываются доходность и риск портфелей, состоящих рисковых и безрисковых активов
+ разобраться в преимуществах диверсификации
+ понять, что такое эффективная граница (effective frontier) и эффективный (оптимальный) портфель
+ понять, что такое тангенциальный портфель (tangency portfolio)
+ посчитать эффективный портфель, состоящий из акций 5 компаний (Газпром, Сбербанк, Норникель, Магнит, МТС)
+ понять ограничения оптимизации "риск/доходность" на практике

 
```{r setup, cache=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

library("RColorBrewer")    # brewer.pal
library("knitr")           # opts_chunk
#library(rusquant)
library(forecast)
library(quadprog)

# color palette
palette(brewer.pal(6, "Set1"))

opts_chunk$set(fig.width=12, fig.height=7)
opts_chunk$set(cache=TRUE, fig.align="center", comment=NA, echo=TRUE, tidy=FALSE)

# преобразовать объект xts в dataframe с сохранением индекса даты
XtstoDf <- function(ts, ...){ 
  df <- as.data.frame(ts)
  df$date <- time(ts)
  return(df)
}
load('../.RData')
```

## Риск и доходность 

+ Базовая концепция в финансах -- это компромисс между риском и доходностью. 
+ Если вам предлагают две инвестиции с одинаковым уровня ожидаемого риска, но разной ожидаемой доходностью, вы выберете вариант, который предлагает **большую доходность**. 
+ Если две инвестиции предлагают одинаковый уровень ожидаемой доходности, но разный уровень риска, то вы выберете инвестицию с **меньшим уровнем риска**. 
+ Но что делать, если вам надо распределить ваши свободные сбережения между 30 наиболее ликвидными бумагами, которые торгуются на российском (или на глобальном рынке) рынке. Как выбрать доли распределения в портфеле? 
+ Оптимальное распределение долей в портфеле -- задача **asset allocation** -- важный вопрос. Основная часть отличий в риск/доходностях разных портфелей связаны именно с распределением долей, а не с различиями в доходностях отдельных активов. 

## Гарри Марковиц (Harry Markowitz) -- основатель современной портфельной теории 

+  **Markowitz, H.M. (March 1952). "Portfolio Selection". The Journal of Finance. 7 (1): 77–91** -- статья, которая заложила основы современной портфельной теории (modern portfolio theory). 
+ Идеи MPT по сути привели к созданию всей отрасли пассивного инвестирования. В настоящее время индексные фонды управляют триллионами долларов. 

<div align="center">
  <img src="fig/harry-markowitz.jpg" width="850" height="565" />
</div>

## Корреляция и ковариация двух активов -- пример

Пусть у нас есть акции компаний - А и Б. 
Доходность акций компании А имеет проциклический характер, то есть растет, когда экономика на подъеме. 

Доходность Б носит антициклический характер -- уменьшается, когда экономика на подъеме, но растет, когда наступает спад. 

Предположим, что у нас есть следующее распределение доходностей в зависимости от состояния экономики: 


**Таблица. Предполагаемая доходность для акций компаний А и Б **

| Состояние экономики | Вероятность  | Доходность А | Доходность Б |
|---------------------|--------------|--------------|--------------|
| Подъем              | 0,33         | 0,385        | -0,225       |
| Нормальное          | 0,33         | 0,140        | 0,02         |
| Спад                | 0,33         | -0,105       | 0,265        |



**Таблица. Расчет ожидаемой доходности для акций А **

|             | Доходность | Отклонение от ожид. доходности | Отклонение в квадрате |
|-------------|------------|--------------------------------|-----------------------|
| Подъем      | 0,385      | 0,245                          | 0,060                 |
| Нормальное  | 0,140      | 0,000                          | 0,000                 |
| Спад        | -0,105     | -0,245                         | 0,060                 |

Ожидаемая доходность = 1/3 (0,385 - 0,14 - 0,105) = 0,14 

Дисперсия = 1/3 (0,060 + 0 + 0,060) = 0,04

Стандартное отклонение = 0,20 


**Таблица. Расчет ожидаемой доходности для акций Б **

|             | Доходность | Отклонение от ожид. доходности | Отклонение в квадрате |
|-------------|------------|--------------------------------|-----------------------|
| Подъем      | -0,225     | -0,245                         | 0,060                 |
| Нормальное  | 0,020      | 0,000                          | 0,000                 |
| Спад        | 0,265      | 0,245                          | 0,060                 |

Ожидаемая доходность = 1/3 (-0,225 + 0,2 + 0,265) = 0,02

Дисперсия = 1/3 (0,060 + 0 + 0,060) = 0,04

Стандартное отклонение = 0,20 

## Доходность портфеля из двух акций А и Б

Пусть у нас есть 100 тыс. рублей, который мы поровну распределили между акциями А и Б (по 50 тыс. рублей). 

Какова ожидаемая доходность и стандартное отклонение этого портфеля?


**Таблица. Доходность портфеля из акций А и Б **

| Состояние экономики | Доходность А | Доходность Б | Доход от 50 тыс. рублей вложенных в А | Доход от 50 тыс. рублей вложенных в Б | Доход портфеля (50% А и 50% Б) |
|---------------------|--------------|--------------|---------------------------------------|---------------------------------------|--------------------------------|
| Подъем | 0,385 | -0,225 | 69,25 | 38,75 | 108,00 |
| Нормальное  | 0,140 | 0,020 | 57,00 | 51,00 | 108,00 |
| Спад  | -0,105 | 0,265 | 44,75 | 63,25 | 108,00 |


Результат -- независимо от состояния экономики доходность портфеля составляет 8%, стандартное отклонение = 0. 

Любой риск исключен! 

## Ковариация и корреляция А и Б 

Этот результат -- полное исключение риска - связан с тем, что активы А и Б имеют абсолютную отрицательную корреляцию =-1. 


**Таблица. Ковариация и корреляция А и Б **

| Состояние экономики | Отклонение от ожид. доходности А | Отклонение от ожид. доходности Б | Произведение отклонений доходности |
|---------------------|----------------------------------|----------------------------------|------------------------------------|
| Подъем              | 0,245                            | -0,245                           | -0,060025                          |
| Нормальное          | 0,000                            | 0,000                            | 0                                  |
| Спад                | -0,245                           | 0,245                            | -0,060025                          |

Ковариация = 1/3(-0,060025 + 0 + 0,060025) = -0,04

Корреляция = -0,04/(0,20 * 0,20) = -1


## Ковариация и корреляция доходностей 

+ **Ковариация** позволяет определить, как изменяются доходности двух бумаг -- в одном направлении (положительно), или в противоположных (отрицательно) направлениях. 

$$\sigma_{1,2} = \sum p_i (X_1 - E(X_1))(X_2 - E(X_2)) $$

**Корреляция** -- нормированная на произведение стандартных доходностей ковариация. 

$$\rho = \frac{\sigma_{1,2}}{\sigma_1 \sigma_2} $$

## Безрисковый актив

+ **Безрисковый актив** -- бумага, которая предлагает предсказуемую ставку доходности в выбранной валюте и в пределах горизонта данного инвестора. 
+ Если брать общую ситуацию, когда нет конкретного инвестора, то безрисковыми активам следует считать те из них, которые предлагают предсказуемую доходность инвестору в пределах короткого периода принятия решения -- торгового дня. 
+ Если за расчетную единицу принят рубль, а период принятия решений -- один рабочий день, то безрисковой ставкой доходности можно считать процентную ставку по коротким ОФЗ. 
+ Другие альтернативные варианты безрисковой ставки в рублях -- ставка по депозитам Сбербанка или других банков, ставка на рынке межбанковского кредитования (MIACR или другие). 

## Портфель безрискового актива и единственного рискового актива

+ Пусть вы решили инвестировать 100 тыс. рублей. Перед вами безрисковый актив, который предлагает доходность в 8% и рисковый актив с ожидаемой ставкой доходности в 14% и стандартным отклонением в 20% (фондовый индекс). 

Какую часть от 100 тыс. рублей вам следует вложить в рисковый актив? 

Пример расчета соотношений доходности и риска при разных долях в рисковом активе: 

**Таблица. Комбинация риск/доходность для портфеля из рискового и безрискового актива**

| Вариант   портфеля | Доля портфеля в рисковом активе | Доля портфеля в безрисковом активе | Ожидаемая доходность  | Ст. отклонение |
|--------------------|---------------------------------|------------------------------------|----------------------|----------------|
| А                  | 0%                              | 100%                               | 8%                   | 0%             |
| Б                  | 25%                             | 75%                                | 10%                  | 5%             |
| С                  | 50%                             | 50%                                | 11%                  | 10%            |
| E                  | 75%                             | 25%                                | 13%                  | 15%            |
| D                  | 100%                            | 0%                                 | 14%                  | 20%            |

Формула для расчета ожидаемой доходности портфеля: 

$$ E(r) = w E(r_s) + (1-w)r_f = r_f + w[E(r_s) - r_f] $$
где $w$ -- доля портфеля в рисковом активе. 

Если вы выразим $w$, тогда получим 

$$w = \frac{E(r) - r_f}{E(r_s) - r_f}$$
Стандартное отклонение портфеля, состоящего из безрискового актива и рискового актива, равно произведению стандартного отклонения рискового актива на его долю в портфеле. 

$$\sigma = \sigma_s w $$ 

## Кривая риск/доходность - портфель из безрискового и рискового активов

Построим в R график риск/доходность портфеля для разных вариантов w:

```{r}
rf = 0.08 # безрисковая доходность 
r1 <- 0.14 # доходность рискового актива
sd1 <- 0.20 # ст. отклонение рискового актива
w <- seq(0,1, length.out = 200)

r_p <- w*r1 + (1-w)*rf
sd_p <- w*sd1

plot(sd_p, r_p, type = 'l', ylim = c(0,0.14), xlim = c(0,0.20),  xaxs="i", col = 'red',lwd = 2,
     main = 'Кривая риск/доходность - портфель из безрискового и рискового активов',
     xlab = 'Стандартное отклонение портфеля', ylab = 'Доходность портфеля')

```


Соотношение риск/доходность для портфеля из безрискового актива и рискового актива предоставляет собой прямую линию. 

Пересечение линии с нулем по оси х -- безрисковая ставка.

Наклон линии -- $\frac{E(r_s)-r_f}{\sigma_s}$.

Угол наклона кривой характеризует **дополнительную ожидаемую доходность**, предлагаемую рынком для каждой дополнительной единицы риска, которую согласен нести инвестор.

## Портфель из двух рисковых активов 

Рассмотрим ситуацию, когда в портфеле есть два вида рисковых активов. 

В этом случае необходим анализ соотношения риск/доходность портфеля (в прошлый раз мы считали, что риск безрискового актива равен нулю). 

Ожидаемая доходность портфеля будет равна:

$$ E(r) = w E(r_1) + (1-w) E(r_2) $$
формула дисперсии будет выглядеть следующим образом: 

$$\sigma^2 = w^2\sigma_1^2 + (1-w)^2\sigma_2^2 + 2w(1-w)\rho \sigma_1 \sigma_2 $$
(её можно вывести из обычного определения дисперсии). 

## Преимущества диверсификации 

**Важно: дисперсия портфеля зависит от корреляции между активами, в то время как ожидаемая доходность не зависит от нее**. 

Если мы предположим, что $\rho = 1$, тогда 

$$\sigma = w \sigma_1 + (1-w) \sigma_2 $$
То есть, риск портфеля является взвешенной комбинацией рисков актива 1 и актива 2. 

Однако в реальности $\rho < 1$. Это означает, что риск портфеля будет __меньше__ средневзвешенной комбинации рисков отдельных активов в портфеле. 
Это и есть преимущества **диверсификации** -- возможность уменьшить риск без снижения ожидаемой доходности. 

## Распределение ожидаемых доходностей для рисковых активов двух видов

Пусть у нас имеется два рисковых актива (1 и 2). Параметры распределения их доходностей представлены в таблице: 


**Таблица. Распределение ожидаемых доходностей для рисковых активов двух видов**

|                         | Актив 1 | Актив 2 |
|-------------------------|---------|---------|
| Cреднее                 | 0,14    | 0,08    |
| Стандартное отклонение  | 0,20    | 0,15    |
| Корреляция              | 0,00    | 0,00    |

Рассмотрим соотношение риск/доходность для портфеля, который состоит из активов 1 и 2 в разных соотношениях. 

** Таблица. Риск-доходость портфеля при разных соотношениях рисковых активов в портфеле**


| Портфель    | Доля в активе 1 | Доля в активе 2 | Ожидаемая доходность  | Ст. отклонение  |
|--------------|-----------------|-----------------|-----------------------|-----------------|
| А            | 0               | 100%            | 0,0800                | 0,1500          |
| Б            | 25%             | 75%             | 0,0950                | 0,1231          |
| min variance | 36%             | 64%             | 0,1016                | 0,1200          |
| С            | 50%             | 50%             | 0,1100                | 0,1250          |
| D            | 100%            | 0%              | 0,1400                | 0,2000          |



## Кривая риск/доходность для портфеля из двух рисковых активов

Построим кривую риск-доходность для такого портфеля в R:

```{r}
r1 <- 0.14
r2 <- 0.08
sd1 <- 0.20
sd2 <- 0.15
rho <- 0

w <- seq(0,1,length.out = 500)
r_p2 <- w*r1 +(1-w)*r2
sd_p2 <- sqrt(w^2*sd1^2 + (1-w)^2*sd2^2 + 2*w*(1-w)*rho*sd1*sd2)

plot(sd_p2, r_p2,type = 'l', xlim = c(0, 0.21), ylim = c(0.0575, 0.145),  xaxs="i", col = 'black',lwd = 2,
     main = 'Кривая риск/доходность - портфель из двух рисковых активов',
     xlab = 'Стандартное отклонение портфеля', ylab = 'Доходность портфеля')
points(x = 0.12, y = 0.1016, pch = 19)
text(x = 0.12, y = 0.1016, labels = 'Портфель с минимальной дисперсией', adj = -0.1)

```

+ Самая левая точка этого множества -- **портфель с минимальной дисперсией** (**minimum variance portfolio**)
+ Точки на кривой, которые имеют ожидаемую доходность не меньше чем у портфеля с минимальной дисперсией, составляют **эффективную границу** (effective frontier)
+ Портфели, которые находятся на эффективной границе, называются **эффективными портфелями**. 


## Оптимальная комбинация рискованных активов 

Теперь рассмотрим комбинации риск/доходность в ситуации, когда мы можем объединить безрисковый актив и активы 1 и 2. 

```{r, echo=FALSE}
mu1 = 0.14
mu2 = 0.08
sig1 = 0.2
sig2 = 0.15
rho = 0
rf = 0.06
w = seq(0, 1, len = 500)
means = mu2 + rf * w
var = sig1^2 * w^2 + sig2^2 * (1 - w)^2
risk = sqrt(var)

ind = !(risk > min(risk))
ind2 = (means > means[ind])
wt = 0.693
meant = 0.08 + 0.06 * wt
riskt = sqrt(sig1^2 * wt^2 + sig2^2 * (1 - wt)^2)

wp = 0.475
meanp = 0.08 + 0.06 * wp
riskp = sqrt(sig1^2 * wp^2 + sig2^2 * (1 - wp)^2)



plot(risk, means, type = "l", lwd = 1, xlim = c(0, 0.21), ylim = c(0.0575, 0.145), xlab = 'Стандартное отклонение портфеля', ylab = 'ожидаемая доходность')
abline(v = 0)
lines(risk[ind2], means[ind2], type = "l", lwd = 5, col = "red")
lines( c(0, riskt), c(rf, meant), col = "blue", lwd =2)
lines(c(0,riskp), c(rf,meanp), col = "purple", lwd = 2, lty = 2)
text(riskt, meant, "T", cex = 1.2)
text(sig1, mu1, "R1", cex = 1.2)
text(sig2, mu2, "R2", cex = 1.2)
text(0, rf, "F", cex = 1.2)
text(riskp, meanp, "P", cex = 1.2)
text(min(risk), means[ind], "MV", cex = 1.2)

```

+ Точка пересечения прямой линии и кривой эффективного портфеля (T) является **оптимальной комбинацией рискованных активов**. Ее также называют **тангенциальным портфелем** (**tangency portfolio**). 

В нашем случае это точка, которой соответствует w = 69,23% (доля рискованного актива 1) в портфеле.
Это означает, что для такого портфеля: $E(r_p) = 0,122$, а  $\sigma = 0,146$.

+ **Точка F** -- доходность безрискового актива
+ **R1, R2** -- портфели состоящие из полностью из актива 1 или актива 2
+ Красным выделена эффективная граница. Портфели которые находятся на ней -- эффективные, портфели, которые находятся на черной линии - не эффективны. 
+ P -- типичный портфель, который находится на эффективной границе (эффективный портфель)

## Показатель Шарпа

+ Обратите внимание, что голубая линии, которая соединяет точку F и T лежит выше пурпурной линии, которая соединяет точку F и типичный портфель. Это означает, что для каждого значения $\sigma_p$ -- голубая линия дает лучшее соотношение риск-доходность, чем пурпурная. 
+ Угол наклона каждой линии, которая проходит через точку F и точку на кривой -- является **"показателем Шарпа"** (Sharpe ratio)

Показатель Шарпа равен: 

$$\frac{E(R_p) - r_f}{\sigma_p} $$

+ по сути показатель Шарпа представляет собой **вознаграждение за риск**. 
+ Любая линия, которая имеет больший угол наклона (показатель Шарпа), обеспечивает более высокий уровень ожидаемой доходности для заданного уровня риска. Поэтому чем выше показатель Шарпа, тем лучше -- неважно, какой уровень риска вы хотите принять. 
+ Точка T будет иметь максимальное значение показателя Шарпа.

## Оптимальный портфель из безрискового и рисковых активов

+ Оптимальный (эффективный) портфель из безрискового и рисковых активов сочетает тангенциальный портфель и безрисковый актив. 
+ Эффективный портфель имеет более высокое ожидаемое значением по сравнению с другими портфелями, которые имеют такое же или меньшее значение риска
+ Эффективный портфель имеет меньший уровень риска по сравнению с другими портфелями, которые имеют аналогичное или большее значение доходности 



## Влияние корреляции на уровень риска портфеля

+ Положительная корреляция между активами увеличивает риск портфеля, отрицательная корреляция - уменьшает риск. Посмотрим на изменение точки T (тангенциальный портфель) при разных значениях корреляции рисковых активов: 

```{r,echo=FALSE, cache=TRUE}
par(mfrow = c(2, 2))
mu1 = 0.14
mu2 = 0.08
sig1 = 0.2
sig2 = 0.15
rf = 0.06
w = seq(-2, 3, len = 500)
means = 0.08 + 0.06 * w

rho = 0.5
V1 = mu1 - rf
V2 = mu2 - rf
z1 = V1 * sig2^2 - V2 * rho * sig1 *sig2
z2 = V2 * sig1^2 - V1 * rho * sig1 * sig2
wt = z1/(z1 + z2)
meant = 0.08 + 0.06 * wt
riskt = sqrt(sig1^2 * wt^2 + sig2^2 * (1 - wt)^2 + 2 * rho * sig1 * sig2 * wt * (1 - wt))
risk  = sqrt(sig1^2 * w^2 + sig2^2 *   (1 - w)^2 + 2 * rho * sig1 * sig2 * w * (1 - w))
ind = !(risk > min(risk))
ind2 = (means > means[ind])
plot(risk, means, type = "l", lwd = 1, xlim = c(0, 0.3), ylim = c(0.0575, 0.18),
     main = paste("rho = ", rho))
abline(v = 0)
lines(risk[ind2], means[ind2], type = "l", lwd = 5, col = "red")
lines( c(0, riskt), c(rf, meant), col = "blue", lwd =2)
text(riskt, meant, "T", cex = 1.2)

rho = 0.3
V1 = mu1 - rf
V2 = mu2 - rf
z1 = V1 * sig2^2 - V2 * rho * sig1 *sig2
z2 = V2 * sig1^2 - V1 * rho * sig1 * sig2
wt = z1/(z1 + z2)
meant = 0.08 + 0.06 * wt
riskt = sqrt(sig1^2 * wt^2 + sig2^2 * (1 - wt)^2 + 2 * rho * sig1 * sig2 * wt * (1 - wt))
risk  = sqrt(sig1^2 * w^2 + sig2^2 *   (1 - w)^2 + 2 * rho * sig1 * sig2 * w * (1 - w))
ind = !(risk > min(risk))
ind2 = (means > means[ind])
plot(risk, means, type = "l", lwd = 1, xlim = c(0, 0.3), ylim = c(0.0575, 0.18),
     main = paste("rho = ", rho))
abline(v = 0)
lines(risk[ind2], means[ind2], type = "l", lwd = 5, col = "red")
lines( c(0, riskt), c(rf, meant), col = "blue", lwd =2)
text(riskt, meant, "T", cex = 1.2)

rho = 0.0
V1 = mu1 - rf
V2 = mu2 - rf
z1 = V1 * sig2^2 - V2 * rho * sig1 *sig2
z2 = V2 * sig1^2 - V1 * rho * sig1 * sig2
wt = z1/(z1 + z2)
meant = 0.08 + 0.06 * wt
riskt = sqrt(sig1^2 * wt^2 + sig2^2 * (1 - wt)^2 + 2 * rho * sig1 * sig2 * wt * (1 - wt))
risk  = sqrt(sig1^2 * w^2 + sig2^2 *   (1 - w)^2 + 2 * rho * sig1 * sig2 * w * (1 - w))
ind = !(risk > min(risk))
ind2 = (means > means[ind])
plot(risk, means, type = "l", lwd = 1, xlim = c(0, 0.3), ylim = c(0.0575, 0.18),
     main = paste("rho = ", rho))
abline(v = 0)
lines(risk[ind2], means[ind2], type = "l", lwd = 5, col = "red")
lines( c(0, riskt), c(rf, meant), col = "blue", lwd =2)
text(riskt, meant, "T", cex = 1.2)

rho = -0.7
V1 = mu1 - rf
V2 = mu2 - rf
z1 = V1 * sig2^2 - V2 * rho * sig1 *sig2
z2 = V2 * sig1^2 - V1 * rho * sig1 * sig2
wt = z1/(z1 + z2)
meant = 0.08 + 0.06 * wt
riskt = sqrt(sig1^2 * wt^2 + sig2^2 * (1 - wt)^2 + 2 * rho * sig1 * sig2 * wt * (1 - wt))
risk  = sqrt(sig1^2 * w^2 + sig2^2 *   (1 - w)^2 + 2 * rho * sig1 * sig2 * w * (1 - w))
ind = !(risk > min(risk))
ind2 = (means > means[ind])
plot(risk, means, type = "l", lwd = 1, xlim = c(0, 0.3), ylim = c(0.0575, 0.18),
     main = paste("rho = ", rho))
abline(v = 0)
lines(risk[ind2], means[ind2], type = "l", lwd = 5, col = "red")
lines( c(0, riskt), c(rf, meant), col = "blue", lwd =2)
text(riskt, meant, "T", cex = 1.2)

par(mfrow = c(1, 1))
```

## Эффективный портфель со множестом рисковых активов 

+ В общем случае у нас может быть множество рисковых активов с разными характеристиками риск-доходности. В матричном виде это означает, что мы минимизируем следующее выражение: 

$$w^T \Sigma w - q R^Tw \rightarrow min$$
где

+ $w$ -- вектор весов портфеля, такой что ($\Sigma w_i = 1$)
+ $\Sigma$ -- матрица ковариаций активов 
+ $q \geq 0$ -- фактор склонности к риску, такой что при q= 0 мы предпочитаем минимальный риск, при $q -> \infty$ мы готовы идти на неограниченный риск. 
+ $R$ -- вектор доходностей активов
+ $w^T \Sigma w$ -- дисперсия доходностей портфеля 
+ $R^T$ -- ожидаемая доходность портфеля. 

Мы можем использовать численные методы, чтобы найти оптимальные значения весов. Обычно используют методы **квадратичного программирования**, которые позволяют находить экстремумы квадратичных функций при заданных линейных ограничениях. В R можно использовать функцию `solve.QP` из пакета `quadprog`. 

## Портфель -- Газпром, Сбербанк и Норникель, Магнит и МТС

Рассмотрим портфель из акций 5 российских компаний из разных отраслей. 


```{r, echo=FALSE, warning=FALSE}
library(PerformanceAnalytics)
library(QuantTools)

quant_tools_to_xts <- function(df, ...){ 
  df <- as.data.frame(df)
  #df$date = as.Date(df$date)
  ts = xts(df[,-1], order.by = df[,1])
  return(ts)
}

# start.date <- as.Date('2010-01-01')
# MICEX <- quant_tools_to_xts(get_finam_data('MICEX', from = start.date, to = Sys.Date())) # индекс ММВБ
# GAZP <- quant_tools_to_xts(get_finam_data('GAZP', from = start.date, to = Sys.Date())) # индекс ММВБ
# SBER <- quant_tools_to_xts(get_finam_data('SBER', from = start.date, to = Sys.Date())) # индекс ММВБ
# sb <- SBER['::2007-07-17']/1000
# SBER <- rbind(SBER[-(1:360)],sb)
# GMKN <- quant_tools_to_xts(get_finam_data('GMKN', from = start.date, to = Sys.Date())) # индекс ММВБ
# MGNT <- quant_tools_to_xts(get_finam_data('MGNT', from = start.date, to = Sys.Date())) # индекс ММВБ
# MTSS <- quant_tools_to_xts(get_finam_data('MTSS', from = start.date, to = Sys.Date())) # индекс ММВБ
# 
# MICEX.rtn <- diff(log(MICEX$close)) # расчет лог-доходности
# GAZP.rtn <- diff(log(GAZP$close)) # расчет лог-доходности
# SBER.rtn <- diff(log(SBER$close)) # расчет лог-доходности
# GMKN.rtn <- diff(log(GMKN$close)) # расчет лог-доходности
# MGNT.rtn <- diff(log(MGNT$close)) # расчет лог-доходности
# MTSS.rtn <- diff(log(MTSS$close)) # расчет лог-доходности
# 

# rtns <- merge(GAZP.rtn, SBER.rtn, GMKN.rtn, MGNT.rtn, MTSS.rtn)
# names(rtns) <- c('GAZP', 'SBER', 'GMKN', 'MGNT', 'MTSS')
# rtns <- rtns[complete.cases(rtns)]

chart.CumReturns(rtns, wealth.index = TRUE, legend.loc = 'topleft', geometric = FALSE,
               main = 'Динамика доходностей акций российских компаний (2006-2021)',
               ylab = '6 июля 2006  = 1')

```

Примечание: в данном случае мы не учитываем выплаченне дивиденды в доходностях. 

## Доходность и риск

Рассчитаем показатели доходности и риска (стандартного отклонения) с помощью функций из пакета `PerformanceAnalytics`.

```{r}
library(PerformanceAnalytics)
Return.annualized(rtns, geometric = FALSE)
```

Максимальная доходность (% в год) у Сбербанка (11,5%), у Магнита - минимальная доходность (около 2,8% за период в год). 

```{r}
StdDev.annualized(rtns, geometric = FALSE)
```

Показатели риска максимальны у акций Сбербанка (32,0%), минимальны -- у акций Газпрома. 

## График риск/доходность

Отобразим полученные сочетания риск-доходность для 5 бумаг на графике: 

```{r}
r <- Return.annualized(rtns, geometric = FALSE)
sd <- StdDev.annualized(rtns, geometric = FALSE)
tab <- cbind(round(as.numeric(r),2),round(as.numeric(sd),2), names(rtns))
tab <- as.data.frame(tab)
tab[,1] <- as.numeric(as.character((tab[,1])))
tab[,2] <- as.numeric(as.character((tab[,2])))
names(tab) <- c('Доходность' ,'Волатильность', 'Тикер')

require(ggplot2)

p <- ggplot(tab, aes(x = Волатильность, y = Доходность, label = Тикер))
p + geom_point()+geom_text(check_overlap = TRUE, vjust  = -1)+
   theme_bw()+
   ggtitle('Cоотношение риск/доходность для 5 бумаг')
```

## Матрица ковариаций 

```{r}
cov(rtns)
```

+ Матрицы ковариаций показывают попарные значения ковариаций в портфеле 
+ Эти матрицы являются одним из основных элементов при портфельном анализе, однако сами по себе достаточно трудны для восприятия
+ Для оценки связи между переменными лучше использовать матрицы корреляций

## Матрица корреляций

```{r}
cor(rtns)
```

+ Наибольшие значения корреляций наблюдаются для Газпрома и Сбербанка, минимальные значения корреляций - для Норникеля и Магнита. 
+ Между всеми бумагами наблюдается достаточно сильная корреляция 

## Расчет эффективной границы портфеля

+ Мы используем функция `eff.frontier`, которая позволяет находить веса бумаг, максмизирующая показатель Шарпа портфеля.
+ Она также позволяет задавать ограничения на значения весов. Если не допускается существование коротких позиций в портфеле, то каждый из весов должен быть больше или равен 0. 
+ Мы также можем задать максимальную долю одной бумаги в портфеле (аргумент `max.allocation`), с тем, чтобы уменьшить концентрацию портфеля. 

```{r, echo=FALSE}
eff.frontier <- function (returns, short="no", 
                          max.allocation=NULL, risk.premium.up=.5, risk.increment=.005){

covariance <- cov(returns)
n <- ncol(covariance)
 
Amat <- matrix (1, nrow=n)
bvec <- 1 #
meq <- 1
 
if(short=="no"){
  Amat <- cbind(1, diag(n))
  bvec <- c(bvec, rep(0, n))
}
 
if(!is.null(max.allocation)){
  if(max.allocation > 1 | max.allocation <0){
  stop("max.allocation must be greater than 0 and less than 1")
}
if(max.allocation * n < 1){
   stop("Need to set max.allocation higher; not enough assets to add to 1")
}
 Amat <- cbind(Amat, -diag(n))
 bvec <- c(bvec, rep(-max.allocation, n))
}
 
# 
loops <- risk.premium.up / risk.increment + 1
loop <- 1
 

eff <- matrix(nrow=loops, ncol=n+3)
# Now I need to give the matrix column names
colnames(eff) <- c(colnames(returns), "Std.Dev", "Exp.Return", "sharpe")
 
# Loop through the quadratic program solver
for (i in seq(from=0, to=risk.premium.up, by=risk.increment)){
  dvec <- colMeans(returns) * i # This moves the solution up along the efficient frontier
  sol <- solve.QP(covariance, dvec=dvec, Amat=Amat, bvec=bvec, meq=meq)
  eff[loop,"Std.Dev"] <- sqrt(sum(sol$solution *colSums((covariance * sol$solution))))*sqrt(252)
  eff[loop,"Exp.Return"] <- as.numeric(sol$solution %*% colMeans(returns))*252
  eff[loop,"sharpe"] <- eff[loop,"Exp.Return"] / eff[loop,"Std.Dev"]
  eff[loop,1:n] <- sol$solution
  loop <- loop+1
}
 
return(as.data.frame(eff))
}


```

```{r}
eff <- eff.frontier(returns=rtns, short="no", max.allocation=.50,
                    risk.premium.up=10, risk.increment=.01)

head(eff)
# Find the optimal portfolio
eff.optimal.point <- eff[eff$sharpe==max(eff$sharpe),]
round(eff.optimal.point,2)

```

+ Эффективный портфель -- тот, который имеет максимальное значения показатель Шарпа. 
+ В нашем случае это портфель, который состоит из 50% Сбербанк, 50% Норникеля.
+ Обратите внимание, что доля Магнита равно максимальной доле (выставленное ограничение)

## Эффективная граница

График эффективной границы 

```{r, echo=FALSE}
p <- ggplot(eff, aes(x=Std.Dev, y=Exp.Return)) + geom_point(alpha=.1, color='red') +
                        geom_point(data=eff.optimal.point, aes(x=Std.Dev, y=Exp.Return, label=sharpe),
                                   color='red', size=5)           +
                        annotate(geom="text", x=eff.optimal.point$Std.Dev,
                                 y=eff.optimal.point$Exp.Return,
                                 label=paste("Волатильность: ",
                                             round(eff.optimal.point$Std.Dev*100, digits=2),"\nДоходность: ",
                                             round(eff.optimal.point$Exp.Return*100, digits=2),"%\nК-т Шарпа: ",
                                             round(eff.optimal.point$sharpe, digits=2), "", sep=""),
                                 hjust=0, vjust=1.2)+
                        ggtitle("Эффективная граница\nи оптимальный портфель") +
                        labs(x="Риск (стандартное отклонение портфеля)", y="Доходность")+theme_bw()
p

```

Отметим отдельные бумаги на графике: 

```{r}
p + geom_point(data = tab, aes(x= Волатильность, y = Доходность))+
  geom_text(data = tab, aes(x= Волатильность, y = Доходность,label = Тикер), vjust = -1)

```


## Эффективный портфель с короткими позициями 

Рассмотрим эффективный портфель, в котором разрешены короткие позиции. Это означает, что некоторые веса могут быть отрицательными. 

```{r}
eff2 <- eff.frontier(returns=rtns, short="yes", max.allocation=.50,
                    risk.premium.up=10, risk.increment=.01)

# Find the optimal portfolio
eff.optimal.point2 <- eff2[eff2$sharpe==max(eff2$sharpe),]
round(eff.optimal.point2,2)

```

Оптимальный портфель с короткими позициями предлагает нам занять короткую позицию по Газпрома и Магнита, по другим -- длинные позиции. 

##  Риск-доходность  портфеля с короткими позициями 

```{r, echo=FALSE}
p <- ggplot(eff2, aes(x=Std.Dev, y=Exp.Return)) + geom_point(alpha=.1, color='red') +
                        geom_point(data=eff.optimal.point2, aes(x=Std.Dev, y=Exp.Return, label=sharpe),
                                   color='red', size=5)           +
                        annotate(geom="text", x=eff.optimal.point2$Std.Dev-0.1,
                                 y=eff.optimal.point2$Exp.Return,
                                 label=paste("Волатильность: ",
                                             round(eff.optimal.point2$Std.Dev*100, digits=2),"\nДоходность: ",
                                             round(eff.optimal.point2$Exp.Return*100, digits=2),"%\nК-т Шарпа: ",
                                             round(eff.optimal.point2$sharpe, digits=2), "", sep=""),
                                 hjust=0, vjust=1.2)+
                        ggtitle("Эффективная граница\nи оптимальный портфель (c короткими позициями)") +
                        labs(x="Риск (стандартное отклонение портфеля)", y="Доходность")+theme_bw()+geom_point(data = tab, aes(x= Волатильность, y = Доходность))+
                        geom_text(data = tab, aes(x= Волатильность, y = Доходность,label = Тикер), vjust = -1)
   
p
```

Разрешение занимать короткие позиции позволило повысить доходность портфеля, но и повысило уровень риска. Однако к-т Шарпа для этого портфеля больше (0,77 вместо 0,63). 

## Ограничение оптимизации портфелей по риск-доходности 

1. Все оценки доходности и риска, которые мы делали, основывались на **исторических данных**. Мы использовали выборочные значения доходностей, дисперсий и ковариационной матрицы (корряляции активов) и предполагали, чтоб они хорошо отражают ожидаемые значения. Это достаточно большое количетсво параметров. Как показывает практика, классифические портфели по Марковицу, максимизирующие показатель Шарпа, являются нестабильными. Существуют другие методы, которые позволяют оценивать ковариационную матрицу, к примеру, **метод Ледуа-Вульфа** ( *Ledoit-Wolf, 2003* ). По сути это shrinkage метод, который "стабилизирует ковариационную матрицу -- возвращает экстремальные значения корряляций к центральным значениям. 
2. Можно также использовать другие методы для оценок ожидаемых доходностей вместо выборочных исторических доходностей. Одним из таких методов является **метод Джеймса-Стайна** ( *James–Stein estimator, 1961*), который также основан на идее shrinkage.  
3.  В классическом варианте оптимизации по Марковицу, мы предполагаем, что **доходности имеют нормальное распределение** -- полностью описываются средним и стандартным отклонением. Однако мы знаем, что доходности не распределены нормально. Есть методы, которые позволяют обойти эти ограничения. 



## Оптимальный портфель из ETF, торгующихся на Московской Бирже 

 + портфели доступны и регулярно обновляются на [http://models.fief.ru/shiny/portfolio/](http://models.fief.ru/shiny/portfolio/)
 + На Москоской Бирже есть торгуемые биржевые фонды  (ETF), доходность которых призвана повторять доходность различных российских и международных биржевых индексов. Преимущества - позволяет "не выбирать" отдельные активы и следить за ними, ниже издержки по сравнению с ПИФами, удобство ликвидности. 
 + Оценка out-of-sample доходностей различных  оптимальных инвестиционных инвестиционных портефелей. 
 

**Global Minimum Variance Portfolio (GMVP)** -- портфель, минимизирующий риск портфеля. 
 
**Maximum Sharpe Ratio Portfolio (MSRP)** -- портфель, максимизирующий доходность портфеля, скорректированную на его риск (по Марковицу).
 
 <div align="center">
  <img src="fig/portfolio-etf.png" width="653" height="496" />
</div>
 

## Cписок использованных источников

1. "Statistics and Data Analysis for Financial Engineering" (David Ruppert & David Matteson)
2. Analyzing Financial Data and Implementing Financial Models Using R (Clifford Ang).
3. ["Introduction to Modern Portfolio Theory"]((http://economistatlarge.com/portfolio-theory/introduction-to-portfolio-theory))
4. ["Computing Efficient Portfolios"](https://faculty.washington.edu/ezivot/econ424/portfoliofunctions.pdf) (Eric Zivot) 
5. [Ledoit, Olivier, and Michael Wolf. "Honey, I shrunk the sample covariance matrix." (2003).](http://www.ledoit.net/honey.pdf)

